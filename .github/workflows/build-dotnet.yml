name: Publish Provance NuGet Packages

# Defines when the workflow should run
on:
  # Trigger the workflow when a new "release" is published on GitHub
  release:
    types: [published]
  # Allows manually triggering the workflow from the GitHub UI
  workflow_dispatch:
    inputs:
      version:
        description: 'Package Version (e.g., 0.0.1)'
        required: true
        type: string

# Define project paths for clarity
env:
  CORE_PROJECT_PATH: src/dotnet/ProvanceProtocol/Provance.Core/Provance.Core.csproj
  MIDDLEWARE_PROJECT_PATH: src/dotnet/ProvanceProtocol/Provance.AspNetCore.Middleware/Provance.AspNetCore.Middleware.csproj
  SOLUTION_FILE: src/dotnet/ProvanceProtocol/ProvanceProtocol.sln

jobs:
  build_and_publish:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout the source code
    - name: Checkout Repository
      uses: actions/checkout@v4

    # 2. Setup the .NET SDK
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x' # Ensure this matches your target framework

    # 3. Restore project dependencies
    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_FILE }}

    # 4. Build both projects in Release configuration
    - name: Build Projects
      # NOTE: There was a typo in the previous version (${{ env.SOLUTION_SOLUTION_FILE }}), corrected to ${{ env.SOLUTION_FILE }}
      run: dotnet build ${{ env.SOLUTION_FILE }} --configuration Release --no-restore

    # --- Determine Version ---
    - name: Get Package Version
      id: get_version
      run: |
        # Use the release tag (e.g., v0.0.1) or the manual input for the package version
        # We strip the 'v' prefix if it exists in the tag name
        RELEASE_VERSION=${{ github.event.release.tag_name }}
        INPUT_VERSION=${{ github.event.inputs.version }}
        
        VERSION=$(echo ${RELEASE_VERSION:-$INPUT_VERSION} | sed 's/v//')
        
        echo "PACKAGE_VERSION=$VERSION" >> $GITHUB_ENV
        echo "Package Version set to: $VERSION"

    # 5. Create NuGet package for Provance.Core
    - name: Pack Provance.Core
      run: dotnet pack ${{ env.CORE_PROJECT_PATH }} --configuration Release --no-build --output nupkg -p:PackageVersion=${{ env.PACKAGE_VERSION }}

    # 6. Create NuGet package for Provance.AspNetCore.Middleware
    - name: Pack Provance.AspNetCore.Middleware
      run: dotnet pack ${{ env.MIDDLEWARE_PROJECT_PATH }} --configuration Release --no-build --output nupkg -p:PackageVersion=${{ env.PACKAGE_VERSION }}

    # 7. Push all created packages to NuGet.org
    - name: Publish all packages to NuGet
      run: dotnet nuget push nupkg/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}